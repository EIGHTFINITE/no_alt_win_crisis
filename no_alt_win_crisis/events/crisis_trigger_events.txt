######################################
#
# Crisis Triggering Events
#
######################################

namespace = crisis_trigger

event = {
	id = crisis_trigger.1
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		is_crises_allowed = yes
		OR = {
			AND = { # Super early start prereqs
				end_game_years_passed >= 0
				OR = {
					has_global_flag = endgame_crisis_early_start #From Ultima Vigilis
					AND = { #Both crisis summoning resolutions active
						is_active_resolution = 	resolution_galacticstudies_extradimensional_experimentation
						is_active_resolution = resolution_galactic_threats_committee
					}
				}
			}
			AND = { # Early start
				end_game_years_passed >= 25
				OR = {
					default_endgame_early_start_triggers = yes
					any_country = {
						is_country_type = default
						OR = {
							has_technology = tech_jump_drive_1
							has_technology = tech_psi_jump_drive_1
						}
					}
					is_active_resolution = resolution_galacticstudies_extradimensional_experimentation
					is_active_resolution = resolution_galactic_threats_committee
				}
			}
			end_game_years_passed >= 50 #Regular Start
		}
		OR = {
			NOT = { has_global_flag = galactic_crisis_happened }
			AND = {
				allowed_crisis_type = all
				has_global_flag = galactic_crisis_recently_fired #because some might take a while to arrive, we don't want two at once
			}
		}
	}

	immediate = {
		random_country = {
			limit = { is_country_type = global_event } # global_event country is always around
			random_list = {
				### Prethoryn Scourge (Swarm)
				10 = {
					modifier = {
						factor = 0
						has_country_flag = only_unbidden_this_time
					}
					modifier = {
						factor = 3
						allowed_crisis_type = prethoryn
					}
					modifier = {
						factor = 0
						OR = {
							allowed_crisis_type = contingency
							allowed_crisis_type = unbidden
							allowed_crisis_type = synth_queen
						}
					}
					modifier = { #anti-boring
						factor = 2
						OR = {
							has_global_flag = no_war_in_heaven
							NOT = {
								any_country = {
									OR = {
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 35
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 50
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 70
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 85
					}
					modifier = {
						factor = 4
						end_game_years_passed >= 100
					}
					modifier = {
						factor = 0
						has_global_flag = prethoryn_invasion_happened
					}
					country_event = { id = crisis.10 days = 200 random = 800 }
					set_global_flag = galactic_crisis_happened
					set_timed_global_flag = {
						flag = galactic_crisis_recently_fired
						years = 25
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_1
						years = 5
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_2
						years = 10
					}
				}

				### Unbidden (Extradimensionals)
				8 = {
					modifier = {
						factor = 3.75
						allowed_crisis_type = unbidden
					}
					modifier = {
						factor = 0
						OR = {
							allowed_crisis_type = contingency
							allowed_crisis_type = prethoryn
							allowed_crisis_type = synth_queen
						}
					}
					modifier = { #anti-boring
						factor = 2
						OR = {
							has_global_flag = no_war_in_heaven
							NOT = {
								any_country = {
									OR = {
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
					modifier = {
						factor = 0.5
						end_game_years_passed < 20
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 35
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 50
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 70
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 85
					}
					modifier = {
						factor = 4
						end_game_years_passed >= 100
					}
					modifier = {
						factor = 0
						has_global_flag = extradimensional_invasion_happened
					}
					country_event = { id = crisis.1000 days = 200 random = 800 }
					set_global_flag = galactic_crisis_happened
					set_timed_global_flag = {
						flag = galactic_crisis_recently_fired
						years = 25
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_1
						years = 5
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_2
						years = 10
					}
				}

				### Contingency (AI)
				10 = {
					modifier = {
						factor = 0
						has_country_flag = only_unbidden_this_time
					}
					modifier = {
						factor = 3
						allowed_crisis_type = contingency
					}
					modifier = {
						factor = 0
						OR = {
							allowed_crisis_type = prethoryn
							allowed_crisis_type = unbidden
							allowed_crisis_type = synth_queen
						}
					}
					modifier = { #anti-boring
						factor = 2
						OR = {
							has_global_flag = no_war_in_heaven
							NOT = {
								any_country = {
									OR = {
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 35
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 50
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 70
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 85
					}
					modifier = {
						factor = 4
						end_game_years_passed >= 100
					}
					modifier = {
						factor = 0
						has_global_flag = ai_invasion_happened
					}
					country_event = { id = crisis.2005 days = 200 random = 800 }
					set_global_flag = galactic_crisis_happened
					set_timed_global_flag = {
						flag = galactic_crisis_recently_fired
						years = 25
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_1
						years = 5
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_2
						years = 10
					}
				}

				### Synth Queen
				10 = {
					modifier = {
						factor = 0
						has_country_flag = only_unbidden_this_time
					}
					modifier = { # incentivize Cetana to show up last or she'll likely murder all the other crises
						factor = 0.5
							any_country = {
							is_crisis_faction = yes
						}
					}
					modifier = {
						factor = 3
						allowed_crisis_type = synth_queen
					}
					modifier = {
						factor = 0
						NOT = { allowed_crisis_type = synth_queen }
					}
					modifier = {
						factor = 0
						OR = {
							allowed_crisis_type = prethoryn
							allowed_crisis_type = unbidden
							allowed_crisis_type = contingency
						}
					}
					modifier = { #anti-boring
						factor = 2
						OR = {
							has_global_flag = no_war_in_heaven
							NOT = {
								any_country = {
									OR = {
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 35
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 50
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 70
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 85
					}
					modifier = {
						factor = 4
						end_game_years_passed >= 100
					}
					modifier = {
						factor = 0
						OR = {
							has_global_flag = synth_queen_happened
							has_machine_age_dlc = no
						}
					}
					country_event = { id = crisis.8005 days = 200 random = 800 }
					set_global_flag = galactic_crisis_happened
					set_timed_global_flag = {
						flag = galactic_crisis_recently_fired
						years = 25
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_1
						years = 5
					}
					set_timed_global_flag = {
						flag = galactic_crisis_early_defeat_tracker_2
						years = 10
					}
				}

				### Repeat Prethoryn Scourge
				10 = {
					modifier = {
						factor = 3
						allowed_crisis_type = all
					}
					modifier = {
						factor = 0
						NOT = { allowed_crisis_type = all }
					}
					modifier = { #anti-boring
						factor = 2
						OR = {
							has_global_flag = no_war_in_heaven
							NOT = {
								any_country = {
									OR = {
										is_country_type = fallen_empire
										is_country_type = awakened_fallen_empire
									}
								}
							}
						}
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 35
					}
					modifier = {
						factor = 2
						end_game_years_passed >= 50
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 70
					}
					modifier = {
						factor = 3
						end_game_years_passed >= 85
					}
					modifier = {
						factor = 4
						end_game_years_passed >= 100
					}
					modifier = {
						factor = 0
						NAND = {
							has_global_flag = prethoryn_invasion_happened
							has_global_flag = extradimensional_invasion_happened
							has_global_flag = ai_invasion_happened
						}
					}
					modifier = {
						factor = 0
						has_global_flag = crisis_events_prethoryn_invasion_begins_fire_only_once
					}
					country_event = { id = crisis.10 days = 200 random = 800 }
					set_global_flag = galactic_crisis_happened
					set_timed_global_flag = {
						flag = galactic_crisis_recently_fired
						years = 12
					}
					set_global_flag = crisis_events_prethoryn_invasion_begins_fire_only_once
					remove_global_flag = crisis_events_approaching_the_outer_rim_fire_only_once
					remove_global_flag = crisis_events_subspace_signal_fire_only_once
					remove_global_flag = crisis_events_vanguard_arrives_fire_only_once
					remove_global_flag = crisis_events_main_invasion_arrives_fire_only_once
					remove_global_flag = prethoryn_transmission
					remove_global_flag = prethoryn_subspace_echoes
					remove_global_flag = prethoryn_approaching_rim
					remove_global_flag = prethoryn_arrival
					remove_global_flag = prethoryn_main_invasion
					remove_global_flag = ongoing_prethoryn_invasion
					remove_global_flag = prethoryn_invasion_defeated
					every_system = {
						limit = { has_star_flag = swarm_invasion_warning }
						remove_star_flag = swarm_invasion_warning
					}
					every_system = {
						limit = { has_star_flag = swarm_invasion_target_1 }
						remove_star_flag = swarm_invasion_target_1
					}
					every_system = {
						limit = { has_star_flag = swarm_invasion_target_2 }
						remove_star_flag = swarm_invasion_target_2
					}
					every_system = {
						limit = { has_star_flag = swarm_invasion_target_3 }
						remove_star_flag = swarm_invasion_target_3
					}
					every_system = {
						limit = { has_star_flag = swarm_invasion_target_4 }
						remove_star_flag = swarm_invasion_target_4
					}
				}

				### Nothing
				120 = {
					modifier = { #bigger chance of nothing if another crisis is active
						factor = 1.25
							any_country = {
							is_crisis_faction = yes
						}
					}
					modifier = {
						subtract = 119
						has_global_flag = endgame_crisis_early_start
					}
				}
			}
		}
	}
}
